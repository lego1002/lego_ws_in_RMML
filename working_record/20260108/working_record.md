**工作目標**：解析馬達回授訊號，並利用 Arduino 實現閉迴路速度控制 (Closed-Loop Speed Control)。

---

### 1. 訊號源解析與硬體介面 (Signal Interface)

**初始狀況**：
馬達出廠附帶一組端子 (Pin 3, 5, 7)，原先推測為 AB 相光學編碼器，欲用於讀取高解析度位置。

**遭遇問題 (Issue 1)**：
經查閱工程圖 (PD12-1053081212) 與示波器量測，發現該組訊號實為 **霍爾訊號 (Hall Sensor U/V/W)**，解析度極低 (12 pulses/rev)，且直接讀取雜訊風險高，不適合用於 Arduino 的精密控制。

**解決方案 (Solution)**：

* **策略改變**：改用 DEV 驅動器的 **CN7 Pin 12 (SPD-OUT)** 功能。
* **原理**：驅動器內部將霍爾訊號處理後，轉換為乾淨的方波輸出。
* **參數設定**：將驅動器參數 `06-20` (輸出功能選擇) 確認為 **`101`** (SPD-OUT)。

**遭遇問題 (Issue 2)**：
Arduino 讀取不到訊號，數值浮動。

**解決方案 (Solution)**：

* **電路分析**：確認驅動器輸出為 **NPN Open Collector (Sinking)** 架構。
* **硬體修正**：在 Arduino 端程式啟用 `INPUT_PULLUP` (內部上拉電阻)，解決電位浮接問題。
* **接線定義**：
* Signal: CN7 Pin 12  Arduino D2 (支援中斷)
* GND: CN7 Pin 11  Arduino GND (共地)



---

### 2. 控制模式與電壓匹配 (Control Strategy & Matching)

**初始狀況**：
初期測試採用 PWM Duty 模式 (開迴路)，發現負載變動時轉速不穩。決定切換至閉迴路速度模式。

**遭遇問題 (Issue 3)**：
參數 `01-11` 已設為 `0` (速度模式)，且最大轉速 `02-01` 設為 `10000 RPM`。但在 Arduino 輸出 100% PWM (5V) 時，馬達僅能跑到約 5000 RPM (一半速度)。

**原因分析**：
驅動器參數 `02-09` 預設為 `1` (0-10V 輸入模式)，而 Arduino 僅能輸出 0-5V。導致驅動器判定輸入訊號僅有 50% 強度。

**解決方案 (Solution)**：

* **參數修正**：將 `02-09` 改為 **`0`** (0-5V 輸入模式)。
* **極限設定**：將 `02-01` (最高轉速) 下修為 **`4000 RPM`** (符合馬達物理安全極限)。
* **結果**：Arduino 的 0-255 PWM 數值成功對應 0-4000 RPM 全速域。

---

### 3. 演算法除錯與數據視覺化 (Algorithm Debugging)

**初始狀況**：
使用 Serial Plotter 繪製響應圖，觀察 PID 控制效果。

**遭遇問題 (Issue 4 - 嚴重)**：
回授轉速 (Actual RPM) 的圖表呈現「線性暴衝」，數值衝破 100,000，且圖表更新極度延遲。

**原因分析**：

1. **積分效應**：程式邏輯中未在每次計算後將 `pulseCount` 歸零，導致變數變成「累積圈數」而非「瞬間速度」。
2. **時序阻塞**：主迴圈使用了 `delay(5000)`，導致主程式暫停，但中斷 (Interrupt) 持續在背景計數，造成數據堆積與錯誤放大。

**解決方案 (Solution)**：

* **邏輯修正**：移除 `delay()`，改用 `millis()` 進行非阻塞式計時 (Non-blocking timer)。
* **程式優化**：在計算 RPM 後立即執行 `pulseCount = 0;`。
* **結果**：成功繪製出正確的紅藍對比圖 (Target vs Actual)，驗證了閉迴路控制的追隨性。

---

### 4. 物理限制評估 (Physical Constraints)

**評估目標**：
確認載具是否能達到  之設計極速。

**計算分析**：

* 減速比：
* 馬達安全轉速上限：
* 假設輪徑： (20吋)
* 推算極速：



**結論**：
目前的硬體配置 (主要是 47:1 的高減速比) 限制了極速表現。若必須達到 3m/s，需更換更大輪徑或調整減速機，純軟體控制無法突破此物理限制。

---

### 5. 最終產出與程式碼版本 (Final Output)

* **完成項目**：
1. Arduino Nano 自動化測試程式 (暖身 -> 停車 -> 衝刺 -> 緩行 循環)。
2. Serial Plotter 驗證圖表 (證明命令追隨良好)。
3. 安全性機制 (定義 DIR 腳位防止懸空干擾)。


* **目前參數設定**：
* `01-11`: `0` (Speed Mode)
* `02-01`: `4000` (Max RPM)
* `02-09`: `0` (0-5V Input)
* `06-20`: `101` (SPD-OUT)


